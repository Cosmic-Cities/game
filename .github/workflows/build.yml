name: Build Cosmic Cities

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe
        run: |
          choco install haxe
          haxelib install flixel
          haxelib install flixel-addons
          haxelib install flixel-ui
          haxelib install firetongue
          haxelib install nape-haxe4
          haxelib install hxdiscord_rpc
          haxelib install ase
          haxelib install actuate
          haxelib install polymod
          haxelib run lime setup
      - name: Build Windows
        run: lime build windows -cpp
      - uses: actions/upload-artifact@v4
        with:
          name: windows-bin
          path: export/windows/bin

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe
        run: |
          sudo apt update
          sudo apt install -y haxe
          haxelib install flixel
          haxelib install flixel-addons
          haxelib install flixel-ui
          haxelib install firetongue
          haxelib install nape-haxe4
          haxelib install hxdiscord_rpc
          haxelib install ase
          haxelib install actuate
          haxelib install polymod
          haxelib run lime setup
      - name: Build Linux
        run: lime build linux -cpp
      - uses: actions/upload-artifact@v4
        with:
          name: neko-bin
          path: export/neko/bin

  build-html5:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe
        run: |
          choco install haxe
          haxelib install flixel
          haxelib install flixel-addons
          haxelib install flixel-ui
          haxelib install firetongue
          haxelib install nape-haxe4
          haxelib install hxdiscord_rpc
          haxelib install ase
          haxelib install actuate
          haxelib install polymod
          haxelib run lime setup
      - name: Build HTML5
        run: lime build html5
      - uses: actions/upload-artifact@v4
        with:
          name: html5-bin
          path: export/html5/bin

  build-macos-ios:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v4
      - name: Setup Haxe
        run: |
          brew install haxe
          haxelib install flixel
          haxelib install flixel-addons
          haxelib install flixel-ui
          haxelib install firetongue
          haxelib install nape-haxe4
          haxelib install hxdiscord_rpc
          haxelib install ase
          haxelib install actuate
          haxelib install polymod
          haxelib run lime setup
      - name: Build macOS
        run: lime build mac -cpp
      - name: Build iOS
        run: lime build ios
      - uses: actions/upload-artifact@v4
        with:
          name: ios-macos-bin
          path: |
            export/ios/CosmicCities
            export/neko/bin
