name: Build Axmol Game

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # =========================
  # 1. Build Windows Portable
  # =========================
  build-windows-portable:
    runs-on: windows-latest
    env:
      AX_ROOT: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: choco install ninja llvm cmake -y
      - name: Tool setup via cmdline (setupOnly)
        shell: powershell
        run: powershell -NoProfile -ExecutionPolicy Bypass -File axmol/tools/cmdline/build.ps1 -p win32 -setupOnly
      - name: Configure and build
        run: |
          mkdir build-windows
          cd build-windows
          cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          ninja
      - name: Upload Windows portable build
        uses: actions/upload-artifact@v4
        with:
          name: axmol-windows-portable
          path: build-windows/bin

  # =========================
  # 2. Build Linux
  # =========================
  build-linux:
    runs-on: ubuntu-latest
    env:
      AX_ROOT: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y clang-20 cmake ninja-build build-essential libgtk-3-dev liblzma-dev zip
      - name: Ensure PowerShell is available
        run: sudo apt-get install -y powershell || true
      - name: Tool setup via cmdline (setupOnly)
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File axmol/tools/cmdline/build.ps1 -p linux -setupOnly
      - name: Configure and build
        run: |
          mkdir build-linux
          cd build-linux
          cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang-20 -DCMAKE_CXX_COMPILER=clang++-20
          ninja
      - name: Package Linux build
        run: |
          cd build-linux/bin/Release
          zip -r ../../../../axmol-linux.zip *
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: axmol-linux
          path: axmol-linux.zip

  # =========================
  # 3. Build macOS
  # =========================
  build-macos:
    runs-on: macos-latest
    env:
      AX_ROOT: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: brew install ninja llvm@20 cmake zip ldid
      - name: Install PowerShell
        run: brew install powershell
      - name: Tool setup via cmdline (setupOnly)
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File axmol/tools/cmdline/build.ps1 -p osx -setupOnly
      - name: Configure and build
        run: |
          export PATH="/usr/local/opt/llvm@20/bin:$PATH"
          mkdir -p build-macos
          cd build-macos
          cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
          ninja
      - name: Package macOS app bundle
        run: |
          APP_DIR=build-macos/bin/Release/MyGame.app
          if [ -d "$APP_DIR" ]; then
            zip -r build-macos/axmol-macos.zip "$APP_DIR"
          fi
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: axmol-macos
          path: build-macos/axmol-macos.zip

  # =========================
  # 4. Build iOS (unsigned IPA)
  # =========================
  build-ios:
    runs-on: macos-latest
    env:
      AX_ROOT: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: brew install ninja llvm@20 cmake zip ldid
      - name: Install PowerShell
        run: brew install powershell
      - name: Set up Clang 20
        run: export PATH="/usr/local/opt/llvm@20/bin:$PATH"
      - name: Tool setup via cmdline (setupOnly)
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File axmol/tools/cmdline/build.ps1 -p ios -setupOnly
      - name: Configure CMake for iOS
        run: |
          mkdir -p build-ios
          cd build-ios
          cmake .. \
            -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_REQUIRED=NO \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="" \
            -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM=""
      - name: Build unsigned iOS app
        run: xcodebuild -project MyGame.xcodeproj -configuration Release -scheme MyGame -sdk iphoneos
      - name: Package unsigned IPA
        run: |
          mkdir -p Payload
          cp -r build-ios/Release-iphoneos/MyGame.app Payload/
          zip -r build-ios/MyGame-unsigned.ipa Payload
          rm -rf Payload
      - name: Optional ldid signing
        run: |
          unzip build-ios/MyGame-unsigned.ipa -d build-ios/Payload
          ldid -S build-ios/Payload/MyGame.app/MyGame
          cd build-ios
          zip -r MyGame-unsigned-ldid.ipa Payload
          rm -rf Payload
      - name: Upload IPA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: build-ios/MyGame-unsigned.ipa
      - uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ldid-ipa
          path: build-ios/MyGame-unsigned-ldid.ipa

  # =========================
  # 5. Build Android
  # =========================
  build-android:
    runs-on: ubuntu-latest
    env:
      AX_ROOT: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      - name: Ensure PowerShell is available
        run: sudo apt-get install -y powershell || true
      - name: Tool setup via cmdline (setupOnly)
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File axmol/tools/cmdline/build.ps1 -p android -setupOnly
      - name: Install Ninja + CMake
        run: sudo apt-get install -y ninja-build cmake clang-20 zip
      - name: Build Android APK
        run: |
          mkdir -p build-android
          cd build-android
          cmake .. -G "Ninja" -DCMAKE_SYSTEM_NAME=Android -DANDROID_ABI=arm64-v8a -DCMAKE_BUILD_TYPE=Release
          ninja
          # Use Gradle wrapper to assemble APK
          cd ../../
          ./gradlew assembleRelease
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app/build/outputs/apk/release/app-release.apk
